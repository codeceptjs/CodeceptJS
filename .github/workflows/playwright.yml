name: Playwright Tests

on:
  push:
    branches:
      - 3.x
  pull_request:
    branches:
      - '**'

env:
  CI: true
  # Force terminal colors. @see https://www.npmjs.com/package/colors
  FORCE_COLOR: 1
  NODE_VERSION: 20.x
  PLATFORM: ubuntu-22.04

jobs:
  run-unit-tests:
    runs-on: $PLATFORM

    strategy:
      matrix:
        node-version: [$NODE_VERSION]
        browser-restart: ['browser', 'session']

    steps:
    - name: Checkout and install dependencies steps
      uses: CodeceptJS/CodeceptJS/.github/actions/checkoutAndInstallLibs.steps.yml

    - name: Playwright common steps
      uses: CodeceptJS/CodeceptJS/.github/actions/playwright.steps.yml

    - name: run chromium unit tests
      run: ./node_modules/.bin/mocha test/helper/Playwright_test.js --timeout 5000

  run-acceptance-tests:
    runs-on: $PLATFORM

    strategy:
      matrix:
        node-version: [ $NODE_VERSION ]
        browser-restart: [ 'browser', 'session' ]
        browser: [ 'chromium', 'firefox', 'webkit' ]

    steps:
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Checkout and install dependencies steps
        uses: CodeceptJS/CodeceptJS/.github/actions/checkoutAndInstallLibs.steps.yml

      - name: Playwright common steps
        uses: CodeceptJS/CodeceptJS/.github/actions/playwright.steps.yml

      - name: run ${{ matrix.browser }} tests
        run: BROWSER=${{ matrix.browser }} node ./bin/codecept.js run -c test/acceptance/codecept.Playwright.js --grep @Playwright --debug
      - name: run chromium with restart==${{ matrix.browser-restart }} tests
        run: BROWSER_RESTART=${{ matrix.browser-restart }} ./bin/codecept.js run -c test/acceptance/codecept.Playwright.js --grep @Playwright --debug

